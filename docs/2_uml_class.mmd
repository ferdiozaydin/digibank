---
config:
  theme: neutral
---

classDiagram

class User {
  +id: Long
  +username: String
  +salt: String
  +passwordHash: String
  +totpSecret: String
  +pqPublicKey: String
  +role: String
  +fiatBalance: BigDecimal
  +cryptoBalance: BigDecimal
  +hasRole(expectedRole: String): boolean
}

class Transaction {
  +id: Long
  +userId: Long
  +description: String
  +amount: BigDecimal
  +timestamp: LocalDateTime
  +status: String
  +fullName: String
  +bankCode: String
  +address: String
  +recordDate: LocalDate
}

class UserRepository {
  -dbEnabled: boolean
  +upsert(user: User): User
  +findByUsername(username: String): User
  +findAll(): List~User~
  +searchByUsername(q: String): List~User~
  +deleteByUsername(username: String): boolean
}

class TransactionRepository {
  -dbEnabled: boolean
  +create(tx: Transaction): Transaction
  +save(tx: Transaction): void
  +update(tx: Transaction): boolean
  +delete(id: long): boolean
  +findById(id: long): Transaction
  +findAll(): List~Transaction~
  +findByUserId(userId: Long): List~Transaction~
  +search(q: String, userId: Long): List~Transaction~
}

class AuthenticationService {
  +provisionCredentials(user: User, plainPassword: String, totpSecret: String, role: String): void
  +login(user: User, password: String, totpCode: String): boolean
  +verifyPassword(password: String, salt: String, expectedHash: String): boolean
}

class AuditLogger {
  <<singleton>>
  +getInstance(): AuditLogger
  +log(msg: String): void
  +logError(msg: String, e: Exception): void
}

class PaymentService {
  -repository: TransactionRepository
  +processPayment(user: User, amount: BigDecimal, strategy: PaymentStrategy): boolean
  +processCryptoPayment(user: User, amountFiat: BigDecimal, adapter: CryptoAdapter): boolean
}

class PaymentStrategy {
  <<interface>>
  +pay(user: User, amount: BigDecimal): boolean
}

class FiatPaymentStrategy {
  +pay(user: User, amount: BigDecimal): boolean
}

class CryptoPaymentStrategy {
  +pay(user: User, amount: BigDecimal): boolean
}

class CryptoAdapter {
  <<interface>>
  +pay(user: User, amountFiat: BigDecimal): boolean
  +name(): String
}

class BtcAdapter {
  +pay(user: User, amountFiat: BigDecimal): boolean
  +name(): String
}

class EthAdapter {
  +pay(user: User, amountFiat: BigDecimal): boolean
  +name(): String
}

class StablecoinAdapter {
  +pay(user: User, amountFiat: BigDecimal): boolean
  +name(): String
}

class SmartGovernmentService {
  +getBillsForCitizen(citizenId: String): List~GovernmentBill~
  +payBill(billId: String, paymentMethod: String): String
}

class GovernmentBill {
  +id: String
  +type: String
  +amount: BigDecimal
  +dueDate: String
  +paid: boolean
}

class ApiServer {
  -tokenStore: Map~String,User~
  +start(port: int): void
}

class PredictiveAnalyticsService {
  +metricsSnapshot(): Map
  +forecastTraffic(): Map
  +forecastEnergy(): Map
}

class HomeDeviceController {
  +toggleDevice(deviceId: String, on: boolean): void
  +setThermostat(zone: String, target: double): void
}

class InfrastructureController {
  +adjustTrafficSignal(intersection: String, mode: String): void
  +turnOnStreetLight(location: String): void
  +turnOffStreetLight(location: String): void
}

class Command {
  <<interface>>
  +execute(): void
}

class CommandInvoker {
  +submit(cmd: Command): void
  +runAll(): void
}

class ToggleHomeDeviceCommand {
  +execute(): void
}

class TurnOnStreetLightCommand {
  +execute(): void
}

class AdjustTrafficSignalCommand {
  +execute(): void
}

class DailyRoutineTemplate {
  +executeDailyRoutine(invoker: CommandInvoker): void
}

class LightingRoutine
class SecuritySweepRoutine

class Observer {
  <<interface>>
  +update(eventType: String, location: String): void
}

class SensorSystem {
  +addObserver(o: Observer): void
  +removeObserver(o: Observer): void
  +triggerEvent(eventType: String, location: String): void
}

class DirectoryWatcherService {
  +addObserver(o: Observer): void
  +removeObserver(o: Observer): void
  +run(): void
}

class EmailNotificationObserver {
  +update(eventType: String, location: String): void
}

class BankingNotificationService
class EmergencyService
class PublicUtilityService

class CityController {
  +runDailyRoutines(): void
  +simulateCityEvents(): void
}

PaymentService --> TransactionRepository : save(tx)
PaymentService --> PaymentStrategy
PaymentService --> CryptoAdapter
PaymentStrategy <|.. FiatPaymentStrategy
PaymentStrategy <|.. CryptoPaymentStrategy
CryptoAdapter <|.. BtcAdapter
CryptoAdapter <|.. EthAdapter
CryptoAdapter <|.. StablecoinAdapter

ApiServer --> AuthenticationService
ApiServer --> UserRepository
ApiServer --> TransactionRepository
ApiServer --> PaymentService
ApiServer --> SmartGovernmentService
ApiServer --> PredictiveAnalyticsService
ApiServer --> HomeDeviceController

UserRepository --> User
TransactionRepository --> Transaction
AuthenticationService --> User
AuditLogger <-- AuthenticationService
AuditLogger <-- UserRepository
AuditLogger <-- TransactionRepository
AuditLogger <-- PaymentService

SensorSystem --> Observer
DirectoryWatcherService --> Observer
Observer <|.. BankingNotificationService
Observer <|.. EmergencyService
Observer <|.. PublicUtilityService
Observer <|.. EmailNotificationObserver

CommandInvoker --> Command
Command <|.. ToggleHomeDeviceCommand
Command <|.. TurnOnStreetLightCommand
Command <|.. AdjustTrafficSignalCommand

DailyRoutineTemplate <|-- LightingRoutine
DailyRoutineTemplate <|-- SecuritySweepRoutine

CityController --> SensorSystem
CityController --> CommandInvoker
CityController --> InfrastructureController
CityController --> HomeDeviceController
